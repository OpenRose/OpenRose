@*
 * OpenRose - Requirements Management
 * Licensed under the Apache License, Version 2.0.
 * Export Records UI with details preview for all 6 record types.
*@

@page "/traceability"

@using OpenRose.WebUI.Client.Services.ItemzTrace
@using OpenRose.WebUI.Client.SharedModels
@using OpenRose.WebUI.Components.Dialogs
@using System.Text.Json
@using System.ComponentModel.DataAnnotations
@inject IItemzTraceService ItemzTraceService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<MudPaper Class="pa-3 mb-3 align-start d-flex" Outlined="false">
    <MudStack Row="true" Spacing="3">
        <MudIcon Icon="@Icons.Material.Filled.Hub" Size="Size.Large" />
        <MudText Typo="Typo.h5" Align="Align.Left">Traceability</MudText>
        <MudSpacer />
        <MudText Class="mt-3" Typo="Typo.caption">
            Perform Bulk Traceability operation that includes importing / updating / deleting multiple traces from a single view.
        </MudText>
    </MudStack>
</MudPaper>

<MudTabs Outlined="true" Position="Position.Top" Rounded="true" Border="true" 
					 IconColor="Color.Secondary" ScrollIconColor="Color.Secondary" SliderColor = "Color.Secondary"
					 ApplyEffectsToContainer="true" PanelClass="pa-2" MinimumTabWidth="200px" >
    <MudTabPanel Text="Bulk Import" Icon="@Icons.Material.Filled.FileUpload">
        <MudItem xs="12" Class="d-flex align-items-center justify-center mud-width-full mud-height-full py-3">
        <MudPaper Class="d-flex align-items-center justify-center mud-width-full mud-height-full py-3" Width="100%">
        <MudStack Row="false" Spacing="3" AlignItems="AlignItems.Center" JustifyContent="Justify.Center" Class="w-100">
            <MudTooltip Text="Step 1: Provide input JSON file for Inserting / Updating Treaceability record(s)">
                <MudChip T="string" Icon="@Icons.Material.Filled.Numbers" Size="Size.Small" Color="Color.Success">
                    STEP 1
                </MudChip>
            </MudTooltip>
            <MudText Typo="Typo.inherit">
                Provide input JSON file for Inserting / Updating Treaceability record(s)
            </MudText>

            <MudDivider />

            <!-- Scrollable JSON input container -->

                    <MudPaper Outlined="true" Class="pa-2 w-100 mermaid-text-box"
                        Style="max-height: 500px; overflow: auto; background-color:#000000; color:#2cf517;">
                <MudTextField @bind-Value="jsonInput"
                                Label="Paste Traceability JSON here"
                                Lines="20"
                                FullWidth="true"
                                Style="font-family: monospace; color:inherit; background-color:#000000;"
                                Immediate="true"
                                      spellcheck="false" />
            </MudPaper>
            <MudStack Row="false" Spacing="3" AlignItems="AlignItems.Center" JustifyContent="Justify.Center" Class="w-100">
                <MudTooltip Text="Step 2: Submit JSON file for Inserting / Updating Treaceability record(s)">
                    <MudChip T="string" Icon="@Icons.Material.Filled.Numbers" Size="Size.Small" Color="Color.Success">
                        STEP 2
                    </MudChip>
                </MudTooltip>
                <MudText Typo="Typo.inherit">
                    Submit input JSON file for Inserting / Updating Treaceability record(s)
                </MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" JustifyContent="Justify.Center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ProcessJsonAsync">
                    Submit JSON
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="@(() => jsonInput = string.Empty)">
                    Clear
                </MudButton>
            </MudStack>
            </MudStack>
        </MudStack>
	    </MudPaper>
        </MudItem>
	</MudTabPanel>

    <MudTabPanel Icon="@Icons.Material.Filled.RemoveCircle" Text="Bulk Delete ">
        <MudItem xs="12" Class="d-flex align-items-center justify-center mud-width-full mud-height-full py-3">
        <MudPaper Class="d-flex align-items-center justify-center mud-width-full mud-height-full py-3" Width="100%">
        <MudStack Row="false" Spacing="3" AlignItems="AlignItems.Center" JustifyContent="Justify.Center" Class="w-100">

            <!-- Step 1 -->
            <MudTooltip Text="Step 1: Provide input JSON file for deleting traceability record(s)">
                <MudChip T="string" Icon="@Icons.Material.Filled.Numbers" Size="Size.Small" Color="Color.Error">
                    STEP 1
                </MudChip>
            </MudTooltip>
            <MudText Typo="Typo.inherit">
                Provide input JSON file for deleting traceability record(s)
            </MudText>

            <MudAlert Severity="Severity.Error"
                        Variant="Variant.Filled"
                        style="gap: 10px; margin-left : 10px">
                NOTE: Traceability Deletion Process can not be reversed and all traceability links specified in the input JSON will be permanently removed.
            </MudAlert>
            <MudDivider />

            <!-- Scrollable JSON input container -->
                    <MudPaper Outlined="true" Class="pa-2 w-100 mermaid-text-box"
                        Style="max-height: 500px; overflow: auto; background-color:#000000; color:#ff5555;">
                <MudTextField @bind-Value="jsonDeleteInput"
                                Label="Paste Traceability JSON here"
                                Lines="20"
                                FullWidth="true"
                                Style="font-family: monospace; color:inherit; background-color:#000000;"
                                Immediate="true"
                                      spellcheck="false" />
            </MudPaper>

            <!-- Step 2 -->
            <MudTooltip Text="Step 2: Submit JSON file for deleting traceability record(s)">
                <MudChip T="string" Icon="@Icons.Material.Filled.Numbers" Size="Size.Small" Color="Color.Error">
                    STEP 2
                </MudChip>
            </MudTooltip>
            <MudText Typo="Typo.inherit">
                Submit input JSON file for deleting traceability record(s)
            </MudText>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" JustifyContent="Justify.Center">
                <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ProcessDeleteJsonAsync">
                    Submit JSON
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="@(() => jsonDeleteInput = string.Empty)">
                    Clear
                </MudButton>
            </MudStack>

        </MudStack>
        </MudPaper>
        </MudItem>
    </MudTabPanel>


@*     <MudTabPanel Icon="@Icons.Material.Filled.EditNote" Text="Generate JSON">
		<MudItem xs="12" sm="12" md="12" lg="12">
			<MudPaper Class="pa-4 mud-height-full" Width="100%">
							
			</MudPaper>
		</MudItem>
	</MudTabPanel> *@
</MudTabs>

<style>
    .mermaid-text-box::-webkit-scrollbar {
        width: 16px; /* vertical scrollbar thickness */
        height: 16px; /* horizontal scrollbar thickness */
    }

    .mermaid-text-box::-webkit-scrollbar-thumb {
        background-color: #2cf517;
        border-radius: 8px;
    }

    .mermaid-text-box::-webkit-scrollbar-track {
        background-color: #333333;
    }

    /* Firefox */
    .mermaid-text-box {
        scrollbar-width: auto; /* auto | thin | none */
        scrollbar-color: #2cf517 #333333; /* thumb | track */
    }
</style>

@code {
    private string jsonInput { get; set; } = string.Empty;
    private string jsonDeleteInput { get; set; } = string.Empty;

    private async Task ProcessJsonAsync()
    {
        var parsed = TryParseJson(jsonInput, out var parseError);

        if (parsed == null)
        {
            await DialogService.ShowMessageBox("Invalid JSON", parseError);
            return;
        }

        var validationErrors = ValidateDtoCollection(parsed);

        if (validationErrors.Any())
        {
            var errorMessage = string.Join("\n", validationErrors);
            await DialogService.ShowMessageBox("Validation Errors", errorMessage);
            return;
        }

        try
        {
            var response = await ItemzTraceService.__POST_Create_Or_Verify_Itemz_Trace_Collection__Async(parsed);
            await DialogService.ShowMessageBox("Success", $"Processed {response.Count} trace links successfully!");
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("API Error", ex.Message);
        }
    }
   
    private IEnumerable<ItemzTraceDTO>? TryParseJson(string json, out string errorMessage)
    {
        try
        {
            // Collect only required property names from DTO
            var requiredProps = typeof(ItemzTraceDTO)
                .GetProperties()
                .Where(p => Attribute.IsDefined(p, typeof(RequiredAttribute)))
                .Select(p => p.Name)
                .ToHashSet(StringComparer.OrdinalIgnoreCase);

            var doc = JsonDocument.Parse(json);

            int index = 1;
            foreach (var element in doc.RootElement.EnumerateArray())
            {
                foreach (var requiredProp in requiredProps)
                {
                    if (!element.EnumerateObject().Any(p =>
                            string.Equals(p.Name, requiredProp, StringComparison.OrdinalIgnoreCase)))
                    {
                        errorMessage = $"Item {index}: Missing required property '{requiredProp}'.";
                        return null;
                    }
                }
                index++;
            }

            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var result = JsonSerializer.Deserialize<IEnumerable<ItemzTraceDTO>>(json, options);

            errorMessage = string.Empty;
            return result;
        }
        catch (JsonException jex)
        {
            errorMessage = $"Invalid JSON format: {jex.Message}";
            return null;
        }
    }

    private List<string> ValidateDtoCollection(IEnumerable<ItemzTraceDTO> dtos)
    {
        var errors = new List<string>();
        int index = 1;

        foreach (var dto in dtos)
        {
            var validationResults = new List<ValidationResult>();
            var context = new ValidationContext(dto);

            if (!Validator.TryValidateObject(dto, context, validationResults, validateAllProperties: true))
            {
                foreach (var validationResult in validationResults)
                {
                    // Prefix error with item index
                    errors.Add($"Item {index}: {validationResult.ErrorMessage}");
                }
            }

            index++;
        }

        return errors;
    }

    private async Task ProcessDeleteJsonAsync()
    {
        var parsed = TryParseJson(jsonDeleteInput, out var parseError);

        if (parsed == null)
        {
            await DialogService.ShowMessageBox("Invalid JSON", parseError);
            return;
        }

        var validationErrors = ValidateDtoCollection(parsed);

        if (validationErrors.Any())
        {
            var errorMessage = string.Join("\n", validationErrors);
            await DialogService.ShowMessageBox("Validation Errors", errorMessage);
            return;
        }

        try
        {
            await ItemzTraceService.__DELETE_Itemz_Trace_Collection__Async(parsed);
            await DialogService.ShowMessageBox("Success", $"Deleted {parsed.Count()} trace links successfully!");
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("API Error", ex.Message);
        }
    }
}
