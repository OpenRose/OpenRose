@*
 * OpenRose - Requirements Management
 * Licensed under the Apache License, Version 2.0.
 * See the LICENSE file or visit https://github.com/OpenRose/OpenRose for more details.
*@


@using OpenRose.WebUI.Client.Services.JsonFile
@using OpenRose.WebUI.Client.SharedModels
@using OpenRose.WebUI.Components.EventServices
@using OpenRose.WebUI.Components.Pages.Common
@using OpenRose.WebUI.Components.Pages.Itemz.Traceability
@inject TreeNodeItemzSelectionServiceForJson ItemzSelectionServiceForJson
@inject IJSRuntime JS
@inject JsonFileDataSourceService JsonService

<MudGrid>
    @if (initializingPage)
    {
        <MudPaper Width="100%">
            <MudOverlay Visible="@initializingPage" DarkBackground="true" Absolute="true">
                <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Inherit">Loading ...</MudText>
                <br />
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            </MudOverlay>
        </MudPaper>
    }
    else
    {
        <MudItem xs="12" sm="12">
            <MudCard style="background-color:#FABBBB; top:0; z-index:10;">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="12" md="7" lg="7">
                            <MudText Typo="Typo.h5" Align="Align.Left">
                                <strong>@_itemz.Name</strong>
                            </MudText>
                        </MudItem>

                        <MudItem xs="12" sm="12" md="5" lg="5" Class="d-flex justify-end align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleUp"
                                           Color="Color.Success"
                                           Size="Size.Medium"
                                           IconSize="Size.Large"
                                           Variant="Variant.Filled"
                                           Class="mud-rounded-circle me-2"
                                           OnClick="@(() => { if (OnNavigatePrevious.HasDelegate) OnNavigatePrevious.InvokeAsync(ItemzId); })" />

                            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleDown"
                                           Color="Color.Success"
                                           Size="Size.Medium"
                                           IconSize="Size.Large"
                                           Variant="Variant.Filled"
                                           Class="mud-rounded-circle"
                                           OnClick="@(() => { if (OnNavigateNext.HasDelegate) OnNavigateNext.InvokeAsync(ItemzId); })" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="0" Outlined="false" Style="background-color:transparent; overflow-y:auto; max-height:calc(100vh - 200px);">
                <MudCardContent>
                    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.None" AlignItems="AlignItems.Start" Class="w-100">
                        <MudStack Row="true" Spacing="2">
                            <MudText><strong>ID          : </strong></MudText>
                            <CopyableText TextToCopy="@_itemz.Id.ToString()" DisplayLength="8" />
                            <MudTooltip Text="Show in Tree View">
                                <MudIcon Icon="@Icons.Material.Filled.Park" Size="Size.Small" Class="mouse-pointer-icon" @onclick="async () => await findAndShowInTreeViewAsync()" />
                            </MudTooltip>
                        </MudStack>
                        <MudText><strong> || Status      : </strong> @_itemz.Status</MudText>
                        <MudText><strong> || Priority    : </strong> @_itemz.Priority</MudText>
                        <MudText><strong> || Severity    : </strong> @_itemz.Severity</MudText>
                    </MudStack>

                    <br />
                    <div class="custom-markdown-editor">
                        @if (!string.IsNullOrEmpty(_itemz.Description))
                        {
                            <div class="markdown-body">@((MarkupString)_convertedMarkdown)</div>
                        }
                    </div>

                    <TraceabilityReadOnlyComponentForJson ItemzId="@ItemzId"
                                                          OnOpenTraceTarget="OnOpenTraceTarget" />
                </MudCardContent>
            </MudCard>
        </MudItem>
        <br />
    }
</MudGrid>

@code {
    [Parameter] public Guid ItemzId { get; set; }
    [Parameter] public EventCallback<Guid> OnNavigatePrevious { get; set; }
    [Parameter] public EventCallback<Guid> OnNavigateNext { get; set; }
    [Parameter] public EventCallback<Guid> OnOpenTraceTarget { get; set; }

    private bool initializingPage = true;
    private GetItemzDTO _itemz = new();
    private MarkupString _convertedMarkdown;

    protected override async Task OnParametersSetAsync()
    {
        initializingPage = true;

        try
        {
            _itemz = await JsonService.GetItemzDetailsAsync(ItemzId);

            if (!string.IsNullOrEmpty(_itemz.Description))
            {
                var html = await JS.InvokeAsync<string>("markdownToHtml", _itemz.Description);
                _convertedMarkdown = (MarkupString)html;
            }
            else
            {
                _convertedMarkdown = default;
            }
        }
        finally
        {
            initializingPage = false;
        }
    }

    private async Task findAndShowInTreeViewAsync()
    {
        await ItemzSelectionServiceForJson.ScrollToTreeViewNodeAsync(ItemzId);
    }
}
