@*
 * OpenRose - Requirements Management
 * Licensed under the Apache License, Version 2.0.
 * See the LICENSE file or visit https://github.com/OpenRose/OpenRose for more details.
*@

@using OpenRose.WebUI.Client.Services.Hierarchy
@using OpenRose.WebUI.Client.Services.Itemz
@using OpenRose.WebUI.Client.SharedModels
@using OpenRose.WebUI.Components.Pages.Common
@using OpenRose.WebUI.Components.Pages.Itemz.Traceability
@using OpenRose.WebUI.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IDialogService DialogService
@inject IJSRuntime JS

<MudGrid>
    @if (initializingPage)
    {
        <MudPaper Height="calc(100vh - 100px);" Width="100%">
            <MudOverlay Visible="@initializingPage" DarkBackground="true" Absolute="true">
                <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Inherit">Loading ...</MudText>
                <br />
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            </MudOverlay>
        </MudPaper>
    }
    else
    {
        <MudItem xs="12" sm="12">
            <!-- Title Card made sticky -->
            <MudCard style="background-color:#FABBBB; position:sticky; top:0; z-index:10;">
                <MudCardContent>
                    <MudGrid>
                        <!-- Left side: Title -->
                        <MudItem xs="12" sm="12" md="7" lg="7">
                            <MudText Typo="Typo.h5" Align="Align.Left">
                                <strong>@singleItemz.Name</strong>
                            </MudText>
                        </MudItem>

                        <!-- Right side: Circular Icon Buttons -->
                        <MudItem xs="12" sm="12" md="5" lg="5" Class="d-flex justify-end align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleUp"
                                           Color="Color.Success"
                                           Size="Size.Medium"
                                           IconSize="Size.Large"
                                           Variant="Variant.Filled"
                                           Class="mud-rounded-circle me-2"
                                           OnClick="@(() => { if (OnNavigatePrevious.HasDelegate) OnNavigatePrevious.InvokeAsync(ItemzId); })" />

                            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleDown"
                                           Color="Color.Success"
                                           Size="Size.Medium"
                                           IconSize="Size.Large"
                                           Variant="Variant.Filled"
                                           Class="mud-rounded-circle"
                                           OnClick="@(() => { if (OnNavigateNext.HasDelegate) OnNavigateNext.InvokeAsync(ItemzId); })" />

                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Scrollable Content -->
            <MudCard Elevation="0" Outlined="false" Style="background-color:transparent; overflow-y:auto; max-height:calc(100vh - 200px);">
                <MudCardContent>
                    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.None" AlignItems="AlignItems.Start" Class="w-100">
                        <MudStack Row="true" Spacing="2">
                            <MudText><strong>ID          : </strong></MudText>
                            <CopyableText TextToCopy="@singleItemz.Id.ToString()" DisplayLength="8" />
                        </MudStack>
                        <MudText><strong> || Status      : </strong> @singleItemz.Status</MudText>
                        <MudText><strong> || Priority    : </strong> @singleItemz.Priority</MudText>
                        <MudText><strong> || Severity    : </strong> @singleItemz.Severity</MudText>
                    </MudStack>
                    <br />
                    <div class="custom-markdown-editor">
                        @if (!string.IsNullOrEmpty(singleItemz.Description))
                        {
                            <div class="markdown-body">@((MarkupString)convertedMarkdown)</div>
                        }
                    </div>
                    <TraceabilityReadOnlyComponent ItemzId="@ItemzId" />
                </MudCardContent>
            </MudCard>
        </MudItem>
        <br />
    }
</MudGrid>

@if (_showOverlay)
{
	<MudPaper Height="calc(100vh - 100px);" Width="100%">
		<MudOverlay Visible="@_showOverlay" DarkBackground="true" Absolute="true">
			<MudContainer Class="d-flex flex-column justify-center align-center" Style="height: 100%;">
				@* <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Inherit">Moving ... </MudText>
			<br /> *@
				<MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
			</MudContainer>
		</MudOverlay>
	</MudPaper>
}
@code {
	[Parameter]
	public Guid ItemzId { get; set; }

    [Parameter] public EventCallback<Guid> OnNavigatePrevious { get; set; }
    [Parameter] public EventCallback<Guid> OnNavigateNext { get; set; }

	[Inject]
	public IItemzService ItemzService { get; set; }

	public GetItemzDTO singleItemz { get; set; } = new();
	public bool initializingPage { get; set; } = true;
	public bool _showOverlay { get; set; } = false;

	private MarkupString convertedMarkdown;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			initializingPage = true;
			StateHasChanged();
			await Task.Delay(300);

			singleItemz = await ItemzService.__Single_Itemz_By_GUID_ID__Async(ItemzId);
			if (singleItemz != null && singleItemz.Description != null)
			{
				await ConvertMarkdownToHtml(singleItemz.Description);
			}

			initializingPage = false;
			StateHasChanged();
		}
	}

	private async Task ConvertMarkdownToHtml(string markdown)
	{
		if (!string.IsNullOrEmpty(markdown))
		{
			var html = await JS.InvokeAsync<string>("markdownToHtml", markdown);
			convertedMarkdown = (MarkupString)html;
			StateHasChanged();

		}
	}

    // private async Task ScrollUp()
    // {
    //     await JS.InvokeVoidAsync("window.scrollBy", 0, -200); // scroll up by 200px
    // }

    // private async Task ScrollDown()
    // {
    //     await JS.InvokeVoidAsync("window.scrollBy", 0, 200); // scroll down by 200px
    // }

}
