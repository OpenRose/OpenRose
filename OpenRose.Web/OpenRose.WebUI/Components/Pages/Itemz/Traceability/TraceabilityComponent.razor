﻿@*
 * OpenRose - Requirements Management
 * Licensed under the Apache License, Version 2.0.
 * See the LICENSE file or visit https://github.com/OpenRose/OpenRose for more details.
*@

@using OpenRose.WebUI.Client.Services.ItemzTrace
@using OpenRose.WebUI.Client.SharedModels
@using OpenRose.WebUI.Client.Services.Itemz
@using OpenRose.WebUI.Client.Services.ItemzCollection
@using OpenRose.WebUI.Client.SharedModels.ClientSideUIOnlyModel
@using OpenRose.WebUI.Components.EventServices
@using OpenRose.WebUI.Components.Pages.Common
@inject NavigationManager NavManager
@inject IDialogService DialogService
@inject TreeNodeItemzSelectionService ItemzSelectionService

@* <h5>Traceability Component</h5>
<br /> *@
<MudPaper Class="pa-4 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left"> <MudIcon Icon="@Icons.Material.Filled.KeyboardDoubleArrowUp" /> Parent / From Traces </MudText>
	<MudSpacer />
	<MudButton @onclick="async _ => await createParentTrace(ItemzId)" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Primary"> Create Parent Trace </MudButton>
</MudPaper>
<MudDataGrid Items="@AllParentTraceViewModels"
			 Filterable="true"
			 SortMode="@SortMode.None"
			 Groupable="false"
			 Striped="true"
			 FixedHeader="true"
			 HeaderClass="background-color: red;">
	<Columns>
		<PropertyColumn Property="x => x.Id" Title="Id" Filterable="false">
			<CellTemplate>
				<CopyableText TextToCopy="@context.Item.Id.ToString()" DisplayLength="8" />
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Name" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.TraceLabel" Title="Trace Label" Filterable="false">
			<CellTemplate>
				<MudButton Variant="Variant.Text" Color="Color.Primary"
						   OnClick="_ => OpenEditTraceLabelDialogAsync(context.Item.Id, context.Item.TraceLabel, isParent:true)">
					@if (!string.IsNullOrWhiteSpace(context.Item.TraceLabel))
					{
						<MudChip Color="Color.Info">@context.Item.TraceLabel</MudChip>
					}
					else
					{
						<MudChip Color="Color.Default" Variant="Variant.Outlined">
							No Label
						</MudChip>
					}
				</MudButton>
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Status" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.Priority" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<TemplateColumn Title="Action">
			<CellTemplate>
				<div style="display: flex; justify-content: left; align-items: center; gap: 10px;">
					<MudButton Size="@Size.Large"
							   Variant="@Variant.Filled" Color="@Color.Success"
							   OnClick="_ => openItemz(context.Item.Id.ToString())"> Open </MudButton>
					<MudButton Size="@Size.Large"
							   Variant="@Variant.Filled" Color="@Color.Error"
							   style="gap: 10px; margin-left : 10px"
							   OnClick="_ => OpenDeleteParentItemzTraceConfirmationDialogAsync(context.Item.Id,ItemzId)"> Delete </MudButton>
				</div>
			</CellTemplate>
		</TemplateColumn>
	</Columns>
</MudDataGrid>
<MudPaper Class="pa-4 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left"><MudIcon Icon="@Icons.Material.Filled.KeyboardDoubleArrowDown" />Child / To Traces </MudText>
	<MudSpacer />
	<MudButton @onclick="async _ => await createChildTrace(ItemzId)" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Primary"> Create Child Trace </MudButton>
</MudPaper>
<MudDataGrid Items="@AllChildTraceViewModels"
			 Filterable="true"
			 SortMode="@SortMode.None"
			 Groupable="false"
			 Striped="true"
			 FixedHeader="true"
			 HeaderClass="background-color: red;">
	<Columns>
		<PropertyColumn Property="x => x.Id" Title="Id">
			<CellTemplate>
				<CopyableText TextToCopy="@context.Item.Id.ToString()" DisplayLength="8" />
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Name" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.TraceLabel" Title="Trace Label" Filterable="false">
			<CellTemplate>
				<MudButton Variant="Variant.Text" Color="Color.Primary"
						   OnClick="_ => OpenEditTraceLabelDialogAsync(context.Item.Id, context.Item.TraceLabel, isParent:false)">
					@if (!string.IsNullOrWhiteSpace(context.Item.TraceLabel))
					{
						<MudChip Color="Color.Info">@context.Item.TraceLabel</MudChip>
					}
					else
					{
						<MudChip Color="Color.Default" Variant="Variant.Outlined">
							No Label
						</MudChip>
					}
				</MudButton>
			</CellTemplate>
		</PropertyColumn>

		<PropertyColumn Property="x => x.Status" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.Priority" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<TemplateColumn CellClass="d-flex justify-left">
			<CellTemplate>
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Success"
						   OnClick="_ => openItemz(context.Item.Id.ToString())"> Open </MudButton>
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Error"
						   style="gap: 10px; margin-left : 10px"
						   OnClick="_ => OpenDeleteChildItemzTraceConfirmationDialogAsync(ItemzId,context.Item.Id)"> Delete </MudButton>
			</CellTemplate>
		</TemplateColumn>
	</Columns>
</MudDataGrid>

@code {
	[Parameter]
	public Guid ItemzId { get; set; }
	[Parameter]
	[SupplyParameterFromQuery(Name = "calledFrom")]
	public string CalledFrom { get; set; } = string.Empty;

	[Inject]
	public IItemzTraceService ItemzTraceService { get; set; }
	[Inject]
	public IItemzService ItemzService { get; set; }
	[Inject]
	public IItemzCollectionService itemzCollectionService { get; set; }


	private ItemzParentAndChildTraceDTO SingleItemzTraces { get; set; } = new ItemzParentAndChildTraceDTO();

	private ICollection<TraceComponentViewModel> AllParentTraceViewModels { get; set; } = new List<TraceComponentViewModel>();
	private ICollection<TraceComponentViewModel> AllChildTraceViewModels { get; set; } = new List<TraceComponentViewModel>();

	protected override async Task OnInitializedAsync()
	{
		try
		{

			if (ItemzId == Guid.Empty)
			{
				Console.WriteLine("TraceabilityComponent: ItemzId is empty, skipping load.");
				return;
			}

			var singleItemzTraces = await ItemzTraceService.__GET_All_Parent_and_Child_Itemz_Traces_By_ItemzID__Async(ItemzId);

			if (singleItemzTraces?.Itemz != null)
			{
				// --- Parent Traces ---
				if (singleItemzTraces.Itemz.ParentItemz != null && singleItemzTraces.Itemz.ParentItemz.Any())
				{
					var parentIds = singleItemzTraces.Itemz.ParentItemz.Select(p => p.ItemzID).ToList();
					// Use POST-based batch retrieval (avoids long GET URLs / IIS limits)
					var parentItemzDtos = await itemzCollectionService.__POST_Itemz_Collection_By_GUID_IDS__Async(parentIds)
													?? new List<GetItemzDTO>();

					AllParentTraceViewModels = parentItemzDtos
						.Select(dto =>
						{
							var traceInfo = singleItemzTraces.Itemz.ParentItemz.FirstOrDefault(t => t.ItemzID == dto.Id);
							return new TraceComponentViewModel
							{
								Id = dto.Id,
								Name = dto.Name,
								Status = dto.Status,
								Priority = dto.Priority,
								TraceLabel = traceInfo?.TraceLabel
							};
						})
						.ToList();
				}

				// --- Child Traces ---
				if (singleItemzTraces.Itemz.ChildItemz != null && singleItemzTraces.Itemz.ChildItemz.Any())
				{
					var childIds = singleItemzTraces.Itemz.ChildItemz.Select(c => c.ItemzID).ToList();
					// Use POST-based batch retrieval (avoids long GET URLs / IIS limits)
					var childItemzDtos = await itemzCollectionService.__POST_Itemz_Collection_By_GUID_IDS__Async(childIds)
												?? new List<GetItemzDTO>();

					AllChildTraceViewModels = childItemzDtos
						.Select(dto =>
						{
							var traceInfo = singleItemzTraces.Itemz.ChildItemz.FirstOrDefault(t => t.ItemzID == dto.Id);
							return new TraceComponentViewModel
							{
								Id = dto.Id,
								Name = dto.Name,
								Status = dto.Status,
								Priority = dto.Priority,
								TraceLabel = traceInfo?.TraceLabel
							};
						})
						.ToList();
				}
			}

			StateHasChanged();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"TraceabilityComponent init failed: {ex}");
			await DialogService.ShowMessageBox("ERROR", new MarkupString($"<p style=\"color:red\">{ex.Message}</p>"), yesText: "OK");
		}
	}

	public async Task openItemz(string itemzId)
	{
		ItemzSelectionService.SelectTreeNodeItemz(Guid.Parse(itemzId));
		ItemzSelectionService.ScrollToTreeViewNode(Guid.Parse(itemzId));

		if (CalledFrom == nameof(ItemzDetails))
		{
			NavManager.NavigateTo($"/itemzDetails/{itemzId}", true);
		}
	}

	private async Task OpenDeleteParentItemzTraceConfirmationDialogAsync(Guid fromTraceItemzId, Guid toTraceItemzId)
	{
		var options = new DialogOptions { CloseButton = true, CloseOnEscapeKey = true, Position = DialogPosition.Center };
		var dialogref = await DialogService.ShowAsync<TraceabilityDeletionConfirmDialog>("CONFIRM", options);
		var dialogresult = await dialogref.Result;
		if (!(dialogresult!.Canceled))
		{
			await deleteParentItemzTrace(fromTraceItemzId, toTraceItemzId);
		}
	}

	public async Task deleteParentItemzTrace(Guid fromTraceItemzId, Guid toTraceItemzId)
	{
		try
		{
			ItemzTraceDTO tempDeleteItemzTraceDTO = new ItemzTraceDTO();
			tempDeleteItemzTraceDTO.FromTraceItemzId = fromTraceItemzId;
			tempDeleteItemzTraceDTO.ToTraceItemzId = toTraceItemzId;
			await ItemzTraceService.__DELETE_Itemz_Trace__Async(tempDeleteItemzTraceDTO);

			// Remove from the ViewModel collection instead of GetItemzDTO
			var itemToRemove = AllParentTraceViewModels.FirstOrDefault(item => item.Id == fromTraceItemzId);
			if (itemToRemove != null)
			{
				AllParentTraceViewModels.Remove(itemToRemove);
			}

		}
		catch (Exception ex)
		{
			await DialogService.ShowMessageBox("WARNING", markupMessage: new MarkupString($"<p style=\"color: red; \">{ex.Message}</p>"), yesText: "OK");
			return;
		}
	}

	private async Task OpenDeleteChildItemzTraceConfirmationDialogAsync(Guid fromTraceItemzId, Guid toTraceItemzId)
	{
		var options = new DialogOptions { CloseButton = true, CloseOnEscapeKey = true, Position = DialogPosition.Center };
		var dialogref = await DialogService.ShowAsync<TraceabilityDeletionConfirmDialog>("CONFIRM", options);
		var dialogresult = await dialogref.Result;
		if (!(dialogresult!.Canceled))
		{
			await deleteChildItemzTrace(fromTraceItemzId, toTraceItemzId);
		}
	}

	public async Task deleteChildItemzTrace(Guid fromTraceItemzId, Guid toTraceItemzId)
	{
		try
		{
			ItemzTraceDTO tempDeleteItemzTraceDTO = new ItemzTraceDTO();
			tempDeleteItemzTraceDTO.FromTraceItemzId = fromTraceItemzId;
			tempDeleteItemzTraceDTO.ToTraceItemzId = toTraceItemzId;
			await ItemzTraceService.__DELETE_Itemz_Trace__Async(tempDeleteItemzTraceDTO);

			// Remove from the ViewModel collection instead of GetItemzDTO
			var itemToRemove = AllChildTraceViewModels.FirstOrDefault(item => item.Id == toTraceItemzId);
			if (itemToRemove != null)
			{
				AllChildTraceViewModels.Remove(itemToRemove);
			}
		}
		catch (Exception ex)
		{
			await DialogService.ShowMessageBox("WARNING", markupMessage: new MarkupString($"<p style=\"color: red; \">{ex.Message}</p>"), yesText: "OK");
			return;
		}
	}

	public async Task createParentTrace(Guid ItemzId)
	{
		var parameters = new DialogParameters();
		var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
		var dialog = await DialogService.ShowAsync<CreateParentTraceabilityDialog>("Enter Parent Record ID", parameters, options);
		var result = await dialog.Result;

		if (!result.Canceled && result.Data is Guid inputParentItemzId)
		{
			// Verify that ParentItemzId is not present in the current Parent traces.
			// We first check for null and then any otherwise it gives runtime null error
			if (AllParentTraceViewModels.Any(pit => pit.Id == inputParentItemzId))
			{
				await DialogService.ShowMessageBox(
					"INFORMATION",
					markupMessage: new MarkupString($"<p style=\"color: green;\">Trace for record with Id '{ItemzId}' already exists.</p>"),
					yesText: "OK"
				);
				return;
			}

			// Verify recordId exists in repository and is not self‑referencing
			var parentItemzDto = await ItemzService.__Single_Itemz_By_GUID_ID__Async(inputParentItemzId);
			if (parentItemzDto != null && inputParentItemzId != ItemzId)
			{
				var tempItemTraceDTO = new ItemzTraceDTO
				{
					FromTraceItemzId = inputParentItemzId,
					ToTraceItemzId = ItemzId
				};

				try
				{
					// Persist the new trace
					await ItemzTraceService.__POST_Establish_Trace_Between_Itemz__Async(tempItemTraceDTO);

					// Add to ViewModel collection
					var newVm = new TraceComponentViewModel
					{
						Id = parentItemzDto.Id,
						Name = parentItemzDto.Name,
						Status = parentItemzDto.Status,
						Priority = parentItemzDto.Priority,
						TraceLabel = tempItemTraceDTO.TraceLabel // will be null unless you set it
					};

					AllParentTraceViewModels.Add(newVm);
				}
				catch (Exception ex)
				{
					await DialogService.ShowMessageBox(
						"WARNING",
						markupMessage: new MarkupString($"<p style=\"color: red;\">{ex.Message}</p>"),
						yesText: "OK"
					);
				}
				finally
				{
					// Add any clean-up code here.
				}
			}
			else
			{
				await DialogService.ShowMessageBox(
					"WARNING",
					markupMessage: new MarkupString($"<p style=\"color: red;\">Could not find Parent Itemz with ID {inputParentItemzId} in repository.</p>"),
					yesText: "OK"
				);
			}
		}
	}

	public async Task createChildTrace(Guid ItemzId)
	{
		var parameters = new DialogParameters();
		var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
		var dialog = await DialogService.ShowAsync<CreateChildTraceabilityDialog>("Enter Child Record ID", parameters, options);
		var result = await dialog.Result;

		if (!result.Canceled && result.Data is Guid inputChildItemzId)
		{
			// Verify that ChildItemzId is not present in the current child traces.
			// We first check for null and then any otherwise it gives runtime null error
			if (AllChildTraceViewModels.Any(cit => cit.Id == inputChildItemzId))
			{
				await DialogService.ShowMessageBox(
					"INFORMATION",
					markupMessage: new MarkupString($"<p style=\"color: green;\">Trace for record with Id '{ItemzId}' already exists.</p>"),
					yesText: "OK"
				);
				return;
			}

			// Verify recordId exists in your repository and is not self‑referencing
			var childItemzDto = await ItemzService.__Single_Itemz_By_GUID_ID__Async(inputChildItemzId);
			if (childItemzDto != null && inputChildItemzId != ItemzId)
			{
				var tempItemTraceDTO = new ItemzTraceDTO
				{
					FromTraceItemzId = ItemzId,
					ToTraceItemzId = inputChildItemzId
				};

				try
				{
					// Persist the new trace
					await ItemzTraceService.__POST_Establish_Trace_Between_Itemz__Async(tempItemTraceDTO);

					// Add to ViewModel collection
					var newVm = new TraceComponentViewModel
					{
						Id = childItemzDto.Id,
						Name = childItemzDto.Name,
						Status = childItemzDto.Status,
						Priority = childItemzDto.Priority,
						TraceLabel = tempItemTraceDTO.TraceLabel // will be null unless you set it
					};

					AllChildTraceViewModels.Add(newVm);
				}
				catch (Exception ex)
				{
					await DialogService.ShowMessageBox(
						"WARNING",
						markupMessage: new MarkupString($"<p style=\"color: red;\">{ex.Message}</p>"),
						yesText: "OK"
					);
				}
			}
			else
			{
				await DialogService.ShowMessageBox(
					"WARNING",
					markupMessage: new MarkupString($"<p style=\"color: red;\">Could not find Child Itemz with ID {inputChildItemzId} in repository.</p>"),
					yesText: "OK"
				);
			}
		}
	}


	private async Task OpenEditTraceLabelDialogAsync(Guid traceId, string? currentLabel, bool isParent)
	{
		var parameters = new DialogParameters { ["TraceLabel"] = currentLabel ?? string.Empty };
		var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

		var dialog = await DialogService.ShowAsync<EditTraceLabelDialog>("Edit Trace Label", parameters, options);
		var result = await dialog.Result;

		if (!result.Canceled && result.Data is string newLabel)
		{
			try
			{
				// Update DTO and persist via service
				var traceDto = new ItemzTraceDTO
				{
					FromTraceItemzId = isParent ? traceId : ItemzId,
					ToTraceItemzId = isParent ? ItemzId : traceId,
					TraceLabel = newLabel
				};

				await ItemzTraceService.__POST_Establish_Trace_Between_Itemz__Async(traceDto);

				// Update local ViewModel collection
				if (isParent)
				{
					var trace = AllParentTraceViewModels.FirstOrDefault(t => t.Id == traceId);
					if (trace != null) trace.TraceLabel = newLabel;
				}
				else
				{
					var trace = AllChildTraceViewModels.FirstOrDefault(t => t.Id == traceId);
					if (trace != null) trace.TraceLabel = newLabel;
				}
			}
			catch (Exception ex)
			{
				await DialogService.ShowMessageBox("WARNING",
					markupMessage: new MarkupString($"<p style=\"color: red;\">{ex.Message}</p>"), yesText: "OK");
			}
		}
	}



	private List<TraceComponentViewModel> MapChildTraces(
		ItemzParentAndChildTraceDTO traceDto,
		ICollection<GetItemzDTO> childItemzDtos)
	{
		var result = new List<TraceComponentViewModel>();

		if (traceDto?.Itemz?.ChildItemz == null)
			return result;

		foreach (var childTrace in traceDto.Itemz.ChildItemz)
		{
			var itemzDetails = childItemzDtos.FirstOrDefault(i => i.Id == childTrace.ItemzID);

			if (itemzDetails != null)
			{
				result.Add(new TraceComponentViewModel
				{
					Id = itemzDetails.Id,
					Name = itemzDetails.Name,
					Status = itemzDetails.Status,
					Priority = itemzDetails.Priority,
					TraceLabel = childTrace.TraceLabel // merge in the trace label
				});
			}
		}

		return result;
	}

	private List<TraceComponentViewModel> MapParentTraces(
		ItemzParentAndChildTraceDTO traceDto,
		ICollection<GetItemzDTO> parentItemzDtos)
	{
		var result = new List<TraceComponentViewModel>();

		if (traceDto?.Itemz?.ParentItemz == null)
			return result;

		foreach (var parentTrace in traceDto.Itemz.ParentItemz)
		{
			var itemzDetails = parentItemzDtos.FirstOrDefault(i => i.Id == parentTrace.ItemzID);

			if (itemzDetails != null)
			{
				result.Add(new TraceComponentViewModel
				{
					Id = itemzDetails.Id,
					Name = itemzDetails.Name,
					Status = itemzDetails.Status,
					Priority = itemzDetails.Priority,
					TraceLabel = parentTrace.TraceLabel
				});
			}
		}

		return result;
	}


}
