@*
 * OpenRose - Requirements Management
 * Licensed under the Apache License, Version 2.0.
 * See the LICENSE file or visit https://github.com/OpenRose/OpenRose for more details.
*@


@using OpenRose.WebUI.Client.Services.JsonFile
@using OpenRose.WebUI.Client.SharedModels
@using OpenRose.WebUI.Components.Pages.Common
@inject IJSRuntime JS
@inject JsonFileDataSourceService JsonService

<MudGrid>
    @if (initializingPage)
    {
        <MudPaper Height="calc(100vh - 100px);" Width="100%">
            <MudOverlay Visible="@initializingPage" DarkBackground="true" Absolute="true">
                <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Inherit">Loading ...</MudText>
                <br />
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            </MudOverlay>
        </MudPaper>
    }
    else
    {
        <MudItem xs="12" sm="12">
            <MudCard style="background-color:#FABBBB; position:sticky; top:0; z-index:10;">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="12" md="7" lg="7">
                            <MudText Typo="Typo.h5" Align="Align.Left">
                                <strong>@_project.Name</strong>
                            </MudText>
                        </MudItem>

                        <MudItem xs="12" sm="12" md="5" lg="5" Class="d-flex justify-end align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.ArrowCircleDown"
                                           Color="Color.Success"
                                           Size="Size.Medium"
                                           IconSize="Size.Large"
                                           Variant="Variant.Filled"
                                           Class="mud-rounded-circle"
                                           OnClick="@(() => { if (OnNavigateNext.HasDelegate) OnNavigateNext.InvokeAsync(ProjectId); })" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="0" Outlined="false" Style="background-color:transparent;">
                <MudCardContent>
                    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.None" AlignItems="AlignItems.Start" Class="w-100">
                        <MudStack Row="true" Spacing="2">
                            <MudText><strong>ID          : </strong></MudText>
                            <CopyableText TextToCopy="@_project.Id.ToString()" DisplayLength="8" />
                        </MudStack>
                        <MudText><strong> || Status      : </strong> @_project.Status</MudText>
                    </MudStack>

                    <br />
                    <div class="custom-markdown-editor">
                        @if (!string.IsNullOrEmpty(_project.Description))
                        {
                            <div class="markdown-body">@((MarkupString)_convertedMarkdown)</div>
                        }
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <br />
    }
</MudGrid>

@code {
    [Parameter] public Guid ProjectId { get; set; }
    [Parameter] public EventCallback<Guid> OnNavigateNext { get; set; }

    private bool initializingPage = true;
    private GetProjectDTO _project = new();
    private MarkupString _convertedMarkdown;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        initializingPage = true;
        StateHasChanged();

        _project = await JsonService.GetProjectDetailsAsync(ProjectId);

        if (!string.IsNullOrEmpty(_project.Description))
        {
            var html = await JS.InvokeAsync<string>("markdownToHtml", _project.Description);
            _convertedMarkdown = (MarkupString)html;
        }

        initializingPage = false;
        StateHasChanged();
    }
}
