@*
 * OpenRose - Requirements Management
 * Licensed under the Apache License, Version 2.0.
 * See the LICENSE file or visit https://github.com/OpenRose/OpenRose for more details.
*@

@using OpenRose.WebUI.Client.Services.BaselineItemzTrace
@using OpenRose.WebUI.Client.SharedModels
@using OpenRose.WebUI.Client.Services.BaselineItemz
@using OpenRose.WebUI.Client.Services.BaselineItemzCollection
@using OpenRose.WebUI.Client.SharedModels.ClientSideUIOnlyModel
@using OpenRose.WebUI.Components.EventServices
@using OpenRose.WebUI.Components.Pages.Common
@inject NavigationManager NavManager
@inject IDialogService DialogService
@inject BaselineTreeNodeItemzSelectionService BaselineItemzSelectionService

@if (AllParentBaselineTraceViewModels.Count > 0)
{

<MudPaper Class="pa-4 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left"> <MudIcon Icon="@Icons.Material.Filled.KeyboardDoubleArrowUp" /> Parent / From Traces </MudText>
</MudPaper>

<MudDataGrid Items="@AllParentBaselineTraceViewModels"
			 Filterable="true"
			 SortMode="@SortMode.None"
			 Groupable="false"
			 Striped="true"
			 FixedHeader="true"
			 HeaderClass="background-color: red;">
	<Columns>
		<PropertyColumn Property="x => x.Id" Title="Id" Filterable="false">
			<CellTemplate>
				<CopyableText TextToCopy="@context.Item.Id.ToString()" DisplayLength="8" />
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Name" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.TraceLabel" Title="Trace Label" Filterable="false">
			<CellTemplate>
				@if (!string.IsNullOrWhiteSpace(context.Item.TraceLabel))
				{
					<MudChip Color="Color.Info">@context.Item.TraceLabel</MudChip>
				}
				else
				{
					<MudChip Color="Color.Default" Variant="Variant.Outlined">
						No Label
					</MudChip>
				}
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Status" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.Priority" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<TemplateColumn Title="Action">
			<CellTemplate>
				<div style="display: flex; justify-content: left; align-items: center; gap: 10px;">
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Success"
						   OnClick="_ => openBaselineItemz(context.Item.Id.ToString())"> Open </MudButton>
				</div>
			</CellTemplate>
		</TemplateColumn>
	</Columns>
</MudDataGrid>
}

@if (AllChildBaselineTraceViewModels.Count > 0)
{
<MudPaper Class="pa-4 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left"><MudIcon Icon="@Icons.Material.Filled.KeyboardDoubleArrowDown" />Child / To Traces </MudText>
</MudPaper>
<MudDataGrid Items="@AllChildBaselineTraceViewModels"
			 Filterable="true"
			 SortMode="@SortMode.None"
			 Groupable="false"
			 Striped="true"
			 FixedHeader="true"
			 HeaderClass="background-color: red;">
	<Columns>
		<PropertyColumn Property="x => x.Id" Title="Id">
			<CellTemplate>
				<CopyableText TextToCopy="@context.Item.Id.ToString()" DisplayLength="8" />
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Name" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.TraceLabel" Title="Trace Label" Filterable="false">
			<CellTemplate>
				@if (!string.IsNullOrWhiteSpace(context.Item.TraceLabel))
				{
					<MudChip Color="Color.Info">@context.Item.TraceLabel</MudChip>
				}
				else
				{
					<MudChip Color="Color.Default" Variant="Variant.Outlined">
						No Label
					</MudChip>
				}
			</CellTemplate>
		</PropertyColumn>

		<PropertyColumn Property="x => x.Status" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<PropertyColumn Property="x => x.Priority" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<TemplateColumn CellClass="d-flex justify-left">
			<CellTemplate>
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Success"
						   OnClick="_ => openBaselineItemz(context.Item.Id.ToString())"> Open </MudButton>
			</CellTemplate>
		</TemplateColumn>
	</Columns>
</MudDataGrid>
}

@code {
	[Parameter]
	public Guid BaselineItemzId { get; set; }
	[Parameter]
	[SupplyParameterFromQuery(Name = "calledFrom")]
	public string CalledFrom { get; set; } = string.Empty;

	[Inject]
	public IBaselineItemzTraceService baselineItemzTraceService { get; set; }
	// [Inject]
	// public IBaselineItemzService BaselineItemzService { get; set; }
	[Inject]
	public IBaselineItemzCollectionService baselineItemzCollectionService { get; set; }

	private BaselineItemzParentAndChildTraceDTO SingleBaselineItemzTraces { get; set; } = new BaselineItemzParentAndChildTraceDTO();

	private ICollection<TraceComponentViewModel> AllParentBaselineTraceViewModels { get; set; } = new List<TraceComponentViewModel>();
	private ICollection<TraceComponentViewModel> AllChildBaselineTraceViewModels { get; set; } = new List<TraceComponentViewModel>();

	protected override async Task OnInitializedAsync()
	{
		var singleBaselineItemzTraces = await baselineItemzTraceService.__GET_All_Parent_and_Child_Baseline_Itemz_Traces_By_BaselineItemzID__Async(BaselineItemzId);

		if (singleBaselineItemzTraces?.BaselineItemz != null)
		{
			// --- Parent Baseline Traces ---
			if (singleBaselineItemzTraces.BaselineItemz.ParentBaselineItemz != null && singleBaselineItemzTraces.BaselineItemz.ParentBaselineItemz.Any())
			{
				var parentIds = singleBaselineItemzTraces.BaselineItemz.ParentBaselineItemz.Select(p => p.BaselineItemzID).ToList();
				var parentBaselineItemzDtos = await baselineItemzCollectionService.__GET_BaselineItemz_Collection_By_GUID_IDS__Async(parentIds);

				AllParentBaselineTraceViewModels = parentBaselineItemzDtos
					.Select(dto =>
					{
						var traceInfo = singleBaselineItemzTraces.BaselineItemz.ParentBaselineItemz.FirstOrDefault(t => t.BaselineItemzID == dto.Id);
						return new TraceComponentViewModel
						{
							Id = dto.Id,
							Name = dto.Name,
							Status = dto.Status,
							Priority = dto.Priority,
							TraceLabel = traceInfo?.TraceLabel
						};
					})
					.ToList();
			}

			// --- Child Traces ---
			if (singleBaselineItemzTraces.BaselineItemz.ChildBaselineItemz != null && singleBaselineItemzTraces.BaselineItemz.ChildBaselineItemz.Any())
			{
				var childIds = singleBaselineItemzTraces.BaselineItemz.ChildBaselineItemz.Select(c => c.BaselineItemzID).ToList();
				var childBaselineItemzDtos = await baselineItemzCollectionService.__GET_BaselineItemz_Collection_By_GUID_IDS__Async(childIds);

				AllChildBaselineTraceViewModels = childBaselineItemzDtos
					.Select(dto =>
					{
						var traceInfo = singleBaselineItemzTraces.BaselineItemz.ChildBaselineItemz.FirstOrDefault(t => t.BaselineItemzID == dto.Id);
						return new TraceComponentViewModel
						{
							Id = dto.Id,
							Name = dto.Name,
							Status = dto.Status,
							Priority = dto.Priority,
							TraceLabel = traceInfo?.TraceLabel
						};
					})
					.ToList();
			}
		}

		StateHasChanged();
	}

	public async Task openBaselineItemz(string baselineItemzId)
	{
		BaselineItemzSelectionService.SelectBaselineTreeNodeItemz(Guid.Parse(baselineItemzId));
		BaselineItemzSelectionService.ScrollToTreeViewNode(Guid.Parse(baselineItemzId));

		if (CalledFrom == nameof(BaselineItemzDetails))
		{
			NavManager.NavigateTo($"/baselineItemzDetails/{baselineItemzId}", true);
		}
	}
}
